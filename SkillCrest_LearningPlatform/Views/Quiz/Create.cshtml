@model CreateQuizViewModel

<h2>Create Quiz</h2>

<form asp-action="Create" asp-controller="Quiz" method="post">
    <div>
        <label>Quiz Title</label>
        <input type="text" asp-for="Title" class="form-control" />
    </div>
    <input type="hidden" asp-for="CourseId" value="@Model.CourseId" />
    <div id="questions-container" class="questions-container">
        <!-- Questions will be added here dynamically -->
    </div>

    <button type="button" onclick="addQuestion()" class="btn btn-primary">Add Question</button>
    <button type="submit" class="btn btn-success mt-3">Save Quiz</button>
</form>

@section Scripts {
    <script>
        let questionIndex = 0;

        function addQuestion() {
            const questionHtml = `
                        <div class="question-box" id="question_${questionIndex}">
                            <div class="question-header">
                                <h4>Question ${questionIndex + 1}</h4>
                                <label>Question Text</label>
                                <input type="text" name="Questions[${questionIndex}].Text" class="form-control" />

                                <button type="button" onclick="removeQuestion(${questionIndex})" class="btn btn-danger btn-sm">Remove Question</button>
                            </div>

                            <div class="question-type">
                                <label>Question Type</label>
                                <select name="Questions[${questionIndex}].Type" class="form-control" onchange="toggleAddOptionButton(${questionIndex})">
                                    <option value="0">MultipleChoice</option>
                                    <option value="1">RadioButton</option>
                                    <option value="2">OpenText</option>
                                </select>
                            </div>

                            <!-- Option container -->
                            <div class="options-container" id="options_${questionIndex}">
                                <!-- Options for this question will be added here dynamically -->
                            </div>

                            <!-- OpenText Correct Answer input -->
                            <div class="open-text-container" id="openText_${questionIndex}" style="display:none;">
                                <label>Correct Answer Text</label>
                                <input type="text" name="Questions[${questionIndex}].CorrectTextResponse" class="form-control" />
                            </div>

                            <button type="button" class="add-option-button btn btn-info btn-sm" onclick="addOption(${questionIndex})">Add Option</button>
                        </div>
                    `;

            // Append the question HTML to the questions container
            document.getElementById("questions-container").insertAdjacentHTML("beforeend", questionHtml);
            questionIndex++;
        }

        function addOption(questionIdx) {
            const optionsContainer = document.getElementById(`options_${questionIdx}`);
            const optionIndex = optionsContainer.childElementCount;

            // Determine question type to set the input type correctly
            const questionTypeSelect = document.querySelector(`select[name="Questions[${questionIdx}].Type"]`);
            const isRadioButton = questionTypeSelect.value === "1"; // 1 corresponds to RadioButton

            const optionHtml = `
                        <div class="option-box">
                            <label>Option Text</label>
                            <input type="text" name="Questions[${questionIdx}].Options[${optionIndex}].Text" class="form-control option-input" />
                            <label>Is Correct</label>
                            <input type="${isRadioButton ? 'radio' : 'checkbox'}"
                                   name="${isRadioButton ? `Questions[${questionIdx}].IsCorrect` : `Questions[${questionIdx}].Options[${optionIndex}].IsCorrect`}"
                                   value="true" onchange="handleCheckboxChange(this)" />
                            <button type="button" onclick="removeOption(${questionIdx}, ${optionIndex})" class="btn btn-danger btn-sm">Remove Option</button>
                        </div>
                    `;

            optionsContainer.insertAdjacentHTML("beforeend", optionHtml);
        }

        function handleCheckboxChange(input) {
            if (input.type === "radio") {
                // If a radio button is selected, ensure others are deselected
                const optionsContainer = input.closest('.options-container');
                const radios = optionsContainer.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    if (radio !== input) {
                        radio.checked = false;
                    }
                });
            }
        }

        function removeOption(questionIdx, optionIdx) {
            const optionsContainer = document.getElementById(`options_${questionIdx}`);
            const optionToRemove = optionsContainer.querySelectorAll('.option-box')[optionIdx];
            optionsContainer.removeChild(optionToRemove);
        }

        function removeQuestion(questionIdx) {
            const questionToRemove = document.getElementById(`question_${questionIdx}`);
            questionToRemove.remove();
            questionIndex--;
        }

        function toggleAddOptionButton(questionIdx) {
            const questionTypeSelect = document.querySelector(`#question_${questionIdx} .question-type select`);
            const addOptionButton = document.querySelector(`#question_${questionIdx} .add-option-button`);
            const openTextContainer = document.querySelector(`#question_${questionIdx} .open-text-container`);
            const optionsContainer = document.querySelector(`#question_${questionIdx} .options-container`);

            if (questionTypeSelect.value === '2') { // OpenText selected
                addOptionButton.style.display = 'none';
                openTextContainer.style.display = 'block';

                // Remove all options for OpenText
                while (optionsContainer.firstChild) {
                    optionsContainer.removeChild(optionsContainer.firstChild);
                }
            } else {
                addOptionButton.style.display = 'block';
                openTextContainer.style.display = 'none';

                // Update the type of "Is Correct" inputs for existing options
                const isRadioButton = questionTypeSelect.value === '1';
                const isCorrectInputs = optionsContainer.querySelectorAll('input[type="checkbox"], input[type="radio"]');
                isCorrectInputs.forEach((input, idx) => {
                    input.type = isRadioButton ? 'radio' : 'checkbox';
                    input.name = isRadioButton
                        ? `Questions[${questionIdx}].IsCorrect`
                        : `Questions[${questionIdx}].Options[${idx}].IsCorrect`;
                });
            }
        }
    </script>
}


<style>
    .questions-container {
        margin-top: 20px;
    }

    .question-box {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
    }

    .question-header {
        margin-bottom: 10px;
    }

        .question-header h4 {
            margin-bottom: 10px;
        }

    .question-type,
    .options-container {
        margin-top: 15px;
    }

    .option-box {
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .option-box input[type="text"] {
            width: 150px;
        }

        .option-box button {
            margin-left: 10px;
        }

    .add-option-button {
        margin-top: 10px;
    }

    .btn-sm {
        padding: 5px 10px;
    }

    .btn-danger {
        background-color: #e74c3c;
        border: none;
    }

    .btn-info {
        background-color: #3498db;
        border: none;
    }

    .form-control.option-input {
        width: 250px;
        display: inline-block;
    }

    .form-control {
        width: 300px;
        display: inline-block;
    }
</style>
